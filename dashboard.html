<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sunshine Dashboard | SmartQuizzer AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        :root { --sun: #FFCC00; --warm-bg: #FFFDF5; }
        body { background-color: var(--warm-bg) !important; font-family: 'Inter', sans-serif; }
        
        /* Navbar Styling */
        .sun-nav { background: white; border-bottom: 3px solid #FFF4CC; padding: 12px 0; }
        .nav-link-custom { 
            font-weight: 700; color: #444 !important; margin: 0 12px; 
            text-decoration: none; transition: 0.3s; font-size: 0.95rem;
        }
        .nav-link-custom:hover { color: var(--sun) !important; transform: translateY(-2px); }
        .nav-link-custom i { color: var(--sun); margin-right: 5px; }

        /* Generator Card */
        .sunshine-card { background: #ffffff; border-radius: 30px; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .sunshine-input { background: #ffffff !important; border: 2px solid #fff4cc !important; border-radius: 15px !important; }
        .sunshine-input:focus { border-color: var(--sun) !important; box-shadow: 0 0 15px rgba(255, 204, 0, 0.2) !important; }
        
        .sunshine-outline { border: 2px solid var(--sun) !important; color: #b89600 !important; background: transparent; }
        .btn-check:checked + .sunshine-outline { background: var(--sun) !important; color: white !important; }
        
        .sunshine-main-btn { 
            background: linear-gradient(45deg, #ffcc00, #ffb800) !important; 
            color: white !important; border: none !important; border-radius: 20px !important; 
            transition: 0.3s; font-size: 1.1rem;
        }
        .sunshine-main-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(255, 184, 0, 0.4) !important; }
        
        .streak-badge { background: white; border: 1px solid #eee; padding: 8px 20px; border-radius: 50px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

<nav class="sun-nav sticky-top mb-4">
    <div class="container d-flex justify-content-between align-items-center">
        <a href="#" class="navbar-brand fw-bold fs-3" style="color: var(--sun); text-decoration: none;">SmartQuizzer ‚òÄÔ∏è</a>
        <div class="d-none d-md-flex align-items-center">
            <a href="{{ url_for('routes.dashboard') }}" class="nav-link-custom"><i class="fa-solid fa-house"></i> Home</a>
            <a href="{{ url_for('routes.study_hub') }}" class="nav-link-custom"><i class="fa-solid fa-graduation-cap"></i> Study Hub</a>
            <a href="{{ url_for('routes.library') }}" class="nav-link-custom"><i class="fa-solid fa-folder-open"></i> Library</a>
            <a href="{{ url_for('routes.review_mistakes') }}" class="nav-link-custom"><i class="fa-solid fa-triangle-exclamation"></i> Mistakes</a>
            <a href="{{ url_for('routes.logout') }}" class="nav-link-custom text-danger ms-3"><i class="fa-solid fa-power-off"></i></a>
        </div>
    </div>
</nav>

<div class="container pb-5">
    <div class="row mb-4 animate__animated animate__fadeIn">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <div>
                <h2 class="fw-bold" style="color: #4b4b4b;">Rise & Study! ‚òÄÔ∏è</h2>
                <p class="text-muted fw-medium">Welcome back, <b>{{ username }}</b></p>
            </div>
            <div>
                {% if not is_guest %}
                <div class="streak-badge d-flex align-items-center animate__animated animate__pulse animate__infinite">
                    <i class="fa-solid fa-fire text-danger fs-4 me-2"></i>
                    <span class="fw-bold fs-5">{{ streak }} Day Streak</span>
                </div>
                {% else %}
                <div class="badge p-2 px-4 rounded-pill bg-light text-dark border shadow-sm">Guest Mode üë§</div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="sunshine-card p-4 animate__animated animate__fadeInLeft">
                <div class="d-flex align-items-center mb-4">
                    <div class="icon-box me-3 rounded-circle d-flex align-items-center justify-content-center" style="background: #fff9db; width: 60px; height: 60px;">
                        <i class="fa-solid fa-wand-magic-sparkles fs-3" style="color: #ffcc00;"></i>
                    </div>
                    <div>
                        <h4 class="fw-bold mb-0">AI Quiz Engine</h4>
                        <p class="text-muted small mb-0">Convert anything into a quiz in seconds</p>
                    </div>
                </div>

                <form id="quiz-form" enctype="multipart/form-data">
                    <div class="mb-4">
                        <div class="row g-2">
                            <div class="col-6">
                                <input type="radio" class="btn-check" name="quiz_goal" id="rev" value="revision" checked>
                                <label class="btn sunshine-outline w-100 py-3 rounded-4 fw-bold" for="rev">
                                    <i class="fa-solid fa-leaf me-2"></i>Light Revision
                                </label>
                            </div>
                            <div class="col-6">
                                <input type="radio" class="btn-check" name="quiz_goal" id="qz" value="quiz">
                                <label class="btn sunshine-outline w-100 py-3 rounded-4 fw-bold" for="qz" style="border-color: #ff7675 !important; color: #ff7675 !important;">
                                    <i class="fa-solid fa-fire me-2"></i>Deep Test
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="row g-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold small text-muted ms-2">INPUT SOURCE</label>
                            <select name="source_type" id="source-select" class="form-select sunshine-input p-3 fw-bold">
                                <option value="topic">üåê Explore a Topic</option>
                                <option value="pdf">üìÑ Smart PDF Upload</option>
                                <option value="image">üì∏ Scan Image (OCR)</option>
                                <option value="text">‚úçÔ∏è Quick Text Paste</option>
                                {% if not is_guest %}<option value="mistake">üß† Mistake Bank Review</option>{% endif %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold small text-muted ms-2">QUESTION COUNT</label>
                            <input type="range" name="count" class="form-range mt-2" id="countRange" min="1" max="15" value="5" oninput="countOutput.innerText = value">
                            <div class="d-flex justify-content-between text-muted extra-small fw-bold">
                                <span>1</span><span id="countOutput">5</span><span>15</span>
                            </div>
                        </div>
                    </div>

                    <div id="input-area" class="mt-4">
                        <input type="text" name="topic_name" id="topicInput" class="form-control sunshine-input p-4 rounded-pill" placeholder="Enter topic (e.g. Artificial Intelligence)..." required>
                    </div>

                    <div class="mt-5 d-flex gap-3">
                        <button type="submit" class="btn sunshine-main-btn flex-grow-1 py-3 fw-bold shadow-sm" id="submitBtn">
                            Generate Questions Now ü™Ñ
                        </button>
                        <button type="button" id="caseBtn" class="btn btn-dark px-4 rounded-4 fw-bold shadow-sm" title="Start AI Case Challenge">
                            <i class="fa-solid fa-brain fs-5"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="col-lg-4">
            {% if not is_guest %}
            <div class="sunshine-card p-4 mb-4 text-white animate__animated animate__fadeInRight" style="background: linear-gradient(135deg, #FF9800, #FF5722); border-radius: 30px;">
                <h6 class="fw-bold opacity-75">MASTERED QUESTIONS</h6>
                <h2 class="fw-bold display-5">{{ correct_total }}</h2>
                <p class="small mb-0">Total across all topics</p>
            </div>

            <div class="sunshine-card p-4 text-center animate__animated animate__fadeInRight" style="border: 2px solid #fff4cc;">
                <h2 class="display-4 fw-bold" style="color: #ffcc00;">{{ mistake_count }}</h2>
                <p class="text-muted fw-bold">Mistakes in Bank</p>
                <a href="{{ url_for('routes.review_mistakes') }}" class="btn btn-warning w-100 rounded-pill fw-bold shadow-sm">Review Now</a>
            </div>
            {% else %}
            <div class="sunshine-card p-5 text-center border animate__animated animate__fadeInRight" style="border: 2px dashed #ffcc00 !important;">
                <i class="fa-solid fa-lock fs-1 text-warning mb-3"></i>
                <h5 class="fw-bold">Unlock Personal Stats</h5>
                <p class="text-muted small">Save mistakes and track progress.</p>
                <a href="{{ url_for('routes.signup') }}" class="btn sunshine-main-btn w-100 rounded-pill fw-bold">Sign Up Free</a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    // Input Area Toggler
    document.getElementById('source-select').onchange = function() {
        const area = document.getElementById('input-area');
        const val = this.value;
        let html = '';
        if(val === 'topic') html = `<input type="text" name="topic_name" id="topicInput" class="form-control sunshine-input p-4 rounded-pill animate__animated animate__fadeIn" placeholder="Enter topic..." required>`;
        else if(val === 'pdf') html = `<div class="p-4 text-center rounded-4 animate__animated animate__fadeIn" style="background: #fffef0; border: 2px dashed #ffe082;"><input type="file" name="pdf_file" class="form-control" required></div>`;
        else if(val === 'image') html = `<div class="p-4 text-center rounded-4 animate__animated animate__fadeIn" style="background: #fffef0; border: 2px dashed #ffcc00;"><input type="file" name="image_file" class="form-control" accept="image/*" required></div>`;
        else if(val === 'text') html = `<textarea name="raw_text" class="form-control sunshine-input p-4 animate__animated animate__fadeIn" rows="5" placeholder="Paste study material..." required></textarea>`;
        else if(val === 'mistake') html = `<div class="alert alert-warning border-0 rounded-4">AI will fetch questions you got wrong previously.</div>`;
        area.innerHTML = html;
    };

    // AJAX Form Handling
    document.getElementById('quiz-form').onsubmit = async function(e) {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>AI is researching...';
        btn.disabled = true;

        const formData = new FormData(this);
        try {
            const response = await fetch("{{ url_for('routes.handle_generation') }}", {
                method: "POST", body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            const res = await response.json();
            if(res.success) window.location.href = res.redirect;
            else alert("Error: " + res.message);
        } catch (err) { alert("Timeout. Try again!"); }
        finally { btn.innerHTML = "Generate Questions Now ü™Ñ"; btn.disabled = false; }
    };

    // Case Challenge Handling
    document.getElementById('caseBtn').onclick = async function() {
        const topic = document.getElementById('topicInput')?.value || "General Concept";
        this.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        try {
            const response = await fetch("{{ url_for('routes.start_challenge') }}", {
                method: "POST", headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content_to_study: topic })
            });
            const res = await response.json();
            if(res.success) window.location.href = res.redirect;
        } catch(e) { alert("Error starting case study."); }
        finally { this.innerHTML = '<i class="fa-solid fa-brain"></i>'; }
    };
</script>
</body>
</html>

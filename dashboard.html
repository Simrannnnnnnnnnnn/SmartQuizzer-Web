{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4 animate__animated animate__fadeIn">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <div>
                <h2 class="fw-bold" style="color: #4b4b4b;">Rise & Study! ‚òÄÔ∏è</h2>
                <p class="text-muted fw-medium">Let's turn your notes into knowledge.</p>
            </div>
            
            {% if current_user.is_authenticated %}
            <div class="streak-badge p-2 px-4 rounded-pill shadow-sm bg-white border d-flex align-items-center animate__animated {% if streak > 0 %}animate__pulse animate__infinite{% endif %}">
                <i class="fa-solid fa-fire text-danger fs-4 me-2"></i>
                <span class="fw-bold fs-5" style="color: #333;">{{ streak }} Day Streak</span>
            </div>
            {% else %}
            <div class="badge p-2 px-4 rounded-pill bg-light text-dark border shadow-sm">
                <span class="fw-bold text-muted">Guest Mode üë§</span>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm p-4 animate__animated animate__fadeInLeft" 
                 style="background: #ffffff; border-radius: 30px;">
                
                <div class="d-flex align-items-center mb-4">
                    <div class="icon-box me-3 rounded-circle d-flex align-items-center justify-content-center" 
                         style="background: #fff9db; width: 60px; height: 60px;">
                        <i class="fa-solid fa-bolt-lightning fs-3" style="color: #ffcc00;"></i>
                    </div>
                    <div>
                        <h4 class="fw-bold mb-0" style="color: #333;">Quick Quiz Generator</h4>
                        <p class="text-muted small mb-0">Powered by Sunshine AI Engine</p>
                    </div>
                </div>
                
                <form action="{{ url_for('routes.handle_generation') }}" method="POST" enctype="multipart/form-data" id="quiz-form">
                    <div class="mb-4">
                        <div class="row g-2">
                            <div class="col-6">
                                <input type="radio" class="btn-check" name="quiz_goal" id="rev" value="revision" checked>
                                <label class="btn sunshine-outline w-100 py-3 rounded-4 fw-bold" for="rev">
                                    <i class="fa-solid fa-leaf me-2"></i>Light Revision
                                </label>
                            </div>
                            <div class="col-6">
                                <input type="radio" class="btn-check" name="quiz_goal" id="qz" value="quiz">
                                <label class="btn sunshine-outline-red w-100 py-3 rounded-4 fw-bold" for="qz">
                                    <i class="fa-solid fa-fire me-2"></i>Deep Test
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="row g-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold small text-muted ms-2">INPUT SOURCE</label>
                            <select name="source_type" id="source-select" class="form-select sunshine-input p-3 fw-bold">
                                <option value="pdf">üìÑ Smart PDF Upload</option>
                                <option value="image">üì∏ Upload Image (OCR)</option>
                                <option value="text">‚úçÔ∏è Quick Text Paste</option>
                                <option value="topic">üåê Explore a Topic</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-bold small text-muted ms-2">QUESTION COUNT</label>
                            <div class="px-2 pt-2">
                                <input type="range" class="form-range" name="count" id="countRange" min="1" max="15" value="5" 
                                       style="accent-color: #ffcc00;" oninput="countOutput.innerText = value">
                                <div class="d-flex justify-content-between text-muted extra-small mt-1 fw-bold">
                                    <span>1</span><span>8</span><span>15</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="input-area" class="mt-4">
                        <div class="upload-zone p-5 text-center rounded-4" style="background: #fffef0; border: 2px dashed #ffe082;">
                            <input type="file" name="pdf_file" class="form-control d-none" id="fileInput" required onchange="updateFileName(this)">
                            <label for="fileInput" style="cursor: pointer;">
                                <i class="fa-solid fa-cloud-arrow-up fs-1 text-warning mb-3"></i>
                                <h6 class="fw-bold" id="fileNameDisplay">Drop your PDF here or click</h6>
                                <p class="text-muted small mb-0">Sunshine AI will read it in seconds</p>
                            </label>
                        </div>
                    </div>

                    <div class="mt-5">
                        <button type="submit" class="btn sunshine-main-btn w-100 py-3 fs-5 fw-bold shadow-sm" id="submitBtn">
                            Generate <span id="countOutput">5</span> Questions Now ü™Ñ
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="col-lg-4">
            {% if current_user.is_authenticated %}
                <div class="card border-0 shadow-sm p-4 mb-4 animate__animated animate__fadeInRight" 
                     style="background: linear-gradient(135deg, #FF9800 0%, #FF5722 100%); border-radius: 30px; color: white;">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="fw-bold opacity-75 mb-1 text-white">CURRENT STREAK</h6>
                            <h2 class="fw-bold mb-0 text-white">{{ streak }} Days</h2>
                            <p class="small mb-0 text-white">Don't break the chain! üî•</p>
                        </div>
                        <div class="fs-1 text-white">‚ö°</div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm p-4 mb-4 animate__animated animate__fadeInRight" 
                     style="background: white; border-radius: 30px;">
                    <h6 class="fw-bold mb-4 text-muted">Knowledge Vault</h6>
                    <div class="custom-scrollbar" style="max-height: 250px; overflow-y: auto; padding-right: 5px;">
                        {% if topic_mastery %}
                            {% for topic in topic_mastery %}
                            <div class="mb-3">
                                <div class="d-flex justify-content-between small fw-bold mb-1">
                                    <span class="text-truncate" style="max-width: 150px;">{{ topic.topic }}</span> 
                                    <span style="color: #ff9900;">{{ topic.percentage }}%</span> 
                                </div>
                                <div class="progress rounded-pill" style="height: 8px; background: #fff9db;">
                                    <div class="progress-bar" 
                                         style="width: {{ topic.percentage }}%; 
                                         background: {% if topic.percentage > 70 %}linear-gradient(90deg, #2ecc71, #27ae60){% elif topic.percentage > 40 %}linear-gradient(90deg, #ffcc00, #ff9900){% else %}linear-gradient(90deg, #ff7675, #d63031){% endif %}; 
                                         border-radius: 50px;">
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-3">
                                <i class="fa-solid fa-folder-open text-light mb-2 fs-2"></i>
                                <p class="text-muted small">Your vault is empty.<br>Start a quiz to see results!</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="card border-0 shadow-sm p-4 text-center animate__animated animate__fadeInRight" 
                     style="background: linear-gradient(180deg, #ffffff, #fffdf0); border-radius: 30px; border: 1px solid #fff9db !important;">
                    <div class="sun-icon mx-auto mb-3" style="font-size: 2.5rem;">üß†</div>
                    <h6 class="fw-bold text-muted">Mistake Bank</h6>
                    <h2 class="display-4 fw-bold" style="color: #333;">{{ mistake_count }}</h2>
                    <p class="small text-muted mb-4">Questions to re-try</p>
                    <a href="{{ url_for('routes.review_mistakes') }}" 
                       class="btn {% if mistake_count > 0 %}btn-warning text-dark{% else %}btn-dark text-white{% endif %} w-100 py-2 rounded-pill fw-bold shadow-sm">
                        Start Review
                    </a>
                </div>
            {% else %}
                <div class="card border-0 shadow-sm p-5 text-center animate__animated animate__fadeInRight" 
                     style="background: white; border-radius: 30px; border: 2px dashed #ffe082 !important;">
                    <div class="mx-auto mb-4 d-flex align-items-center justify-content-center" 
                         style="background: #fff9db; width: 80px; height: 80px; border-radius: 25px;">
                        <i class="fa-solid fa-unlock-keyhole fs-1 text-warning"></i>
                    </div>
                    <h5 class="fw-bold" style="color: #333;">Unlock Full Potential</h5>
                    <p class="text-muted small mb-4">Register now to track your <b>Daily Streaks</b>, save <b>Knowledge Vaults</b>, and review <b>Mistakes</b>.</p>
                    <a href="{{ url_for('routes.signup') }}" class="btn sunshine-main-btn w-100 py-3 rounded-pill fw-bold shadow-sm mb-3">Join Sunshine AI</a>
                    <p class="small text-muted">Already have an account? <a href="{{ url_for('routes.login') }}" class="text-warning fw-bold text-decoration-none">Login</a></p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
    body { background-color: #fffdf5 !important; }
    
    .sunshine-input {
        background: #ffffff !important;
        border: 2px solid #fff4cc !important;
        border-radius: 15px !important;
    }
    .sunshine-input:focus {
        border-color: #ffcc00 !important;
        box-shadow: 0 0 15px rgba(255, 204, 0, 0.2) !important;
    }

    .sunshine-outline {
        border: 2px solid #ffcc00 !important;
        color: #b89600 !important;
        background: transparent;
    }
    .btn-check:checked + .sunshine-outline {
        background: #ffcc00 !important;
        color: white !important;
    }

    .sunshine-outline-red {
        border: 2px solid #ff7675 !important;
        color: #ff7675 !important;
    }
    .btn-check:checked + .sunshine-outline-red {
        background: #ff7675 !important;
        color: white !important;
    }

    .sunshine-main-btn {
        background: linear-gradient(45deg, #ffcc00, #ffb800) !important;
        color: white !important;
        border: none !important;
        border-radius: 20px !important;
        transition: 0.3s;
    }
    .sunshine-main-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(255, 184, 0, 0.3) !important;
    }

    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #ffcc00; border-radius: 10px; }
    
    .extra-small { font-size: 0.7rem; }
</style>

<script>
    function updateFileName(input) {
        const display = document.getElementById('fileNameDisplay');
        display.innerText = input.files[0] ? input.files[0].name : "File selected: " + input.files[0].name;
    }

    document.getElementById('source-select').onchange = function() {
        const area = document.getElementById('input-area');
        const submitBtn = document.getElementById('submitBtn');
        const currentCount = document.getElementById('countRange').value;

        const configs = {
            pdf: {
                html: '<div class="upload-zone p-5 text-center rounded-4" style="background: #fffef0; border: 2px dashed #ffe082;"><input type="file" name="pdf_file" class="form-control d-none" id="fileInput" required onchange="updateFileName(this)"><label for="fileInput" style="cursor: pointer;"><i class="fa-solid fa-cloud-arrow-up fs-1 text-warning mb-3"></i><h6 class="fw-bold" id="fileNameDisplay">Drop your PDF here or click</h6><p class="text-muted small mb-0">Sunshine AI will read it in seconds</p></label></div>',
                btnText: `Generate ${currentCount} Questions Now ü™Ñ`
            },
            image: {
                html: '<div class="upload-zone p-5 text-center rounded-4" style="background: #f0faff; border: 2px dashed #82ccff;"><input type="file" name="image_file" class="form-control d-none" id="imageInput" accept="image/*" required onchange="updateFileName(this)"><label for="imageInput" style="cursor: pointer;"><i class="fa-solid fa-file-image fs-1 text-primary mb-3"></i><h6 class="fw-bold" id="fileNameDisplay">Upload a clear photo of your notes</h6><p class="text-muted small mb-0">OCR will extract the text for your quiz</p></label></div>',
                btnText: `Scan & Generate ${currentCount} Questions üì∏`
            },
            text: {
                html: '<textarea name="raw_text" class="form-control sunshine-input p-4" rows="6" placeholder="Paste your study notes here and let the sun shine..." required></textarea>',
                btnText: `Create ${currentCount} Questions ‚úçÔ∏è`
            },
            topic: {
                html: '<input type="text" name="topic_name" class="form-control sunshine-input p-4 rounded-pill" placeholder="Enter topic (e.g. photosynthesis)..." required>',
                btnText: `Explore & Generate ${currentCount} Questions üåê`
            }
        };

        area.innerHTML = `<div class="animate__animated animate__fadeIn">${configs[this.value].html}</div>`;
        submitBtn.innerHTML = configs[this.value].btnText;
    };

    document.getElementById('quiz-form').onsubmit = function() {
        const btn = document.getElementById('submitBtn');
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Waking up the Sun...';
        btn.style.opacity = '0.7';
    };
</script>
{% endblock %}
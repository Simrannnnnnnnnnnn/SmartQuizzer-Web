<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Quiz | SmartQuizzer</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <style>
        :root { --primary-gold: #FFD700; --text-color: #2d3436; }
        body { background-color: #f8f9fa; font-family: 'Inter', sans-serif; }
        .glass-card { background: white; border-radius: 30px; border: 1px solid #eee; }
        .option-card { border: 2px solid #eee; background-color: #ffffff; transition: all 0.2s; cursor: pointer; color: #333; }
        .btn-check:checked + .option-card { border-color: #D4A017 !important; background-color: #FFD700 !important; color: #000 !important; transform: translateY(-3px); box-shadow: 0 4px 12px rgba(212, 160, 23, 0.4) !important; }
        .sunshine-btn { background: var(--primary-gold); border: none; border-radius: 15px; font-weight: bold; color: black; box-shadow: 0 5px 0 #D4A017; transition: all 0.1s; }
        .sunshine-btn:active { transform: translateY(3px); box-shadow: 0 2px 0 #D4A017; }
        #ghost-bar { transition: width 1s linear; border-radius: 20px; }
    </style>
</head>
<body>

<div class="container py-4">
    <div id="ghost-container" class="mb-4 d-none animate__animated animate__fadeInDown">
        <div class="d-flex justify-content-between small fw-bold mb-1">
            <span>You üèÉ</span>
            <span class="text-danger">AI Rival üëª</span>
        </div>
        <div class="progress rounded-pill shadow-sm" style="height: 14px; background: #eee; border: 2px solid #fff;">
            <div id="ghost-bar" class="progress-bar bg-danger" style="width: 0%;"></div>
        </div>
    </div>

    <div class="glass-card shadow-lg p-4 p-md-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <span id="mode-badge" class="badge px-4 py-2 rounded-pill fs-6 shadow-sm">MODE</span>
            <div id="timer-box" class="h3 mb-0 text-danger fw-bold d-none">‚è≥ <span id="timer">30</span>s</div>
        </div>

        <div class="mb-4">
            <div class="d-flex justify-content-between align-items-end mb-1">
                <h5 class="fw-bold mb-0">Question <span id="current-q-num">1</span> <span class="text-muted fs-6">of <span id="total-q-num">10</span></span></h5>
                <span id="progress-percent" class="small fw-bold text-primary">0%</span>
            </div>
            <div class="progress" style="height: 8px; border-radius: 10px;">
                <div id="main-progress-bar" class="progress-bar bg-primary progress-bar-striped progress-bar-animated" style="width: 0%;"></div>
            </div>
        </div>

        <hr class="mb-5 opacity-10">

        <h2 id="question-text" class="fw-bold mb-5" style="line-height: 1.4;">Loading question...</h2>

        <div id="feedback-area" class="alert d-none mb-4 rounded-4 shadow-sm animate__animated animate__bounceIn" style="border-left: 8px solid;">
            <h4 id="feedback-status" class="fw-bold"></h4>
            <p id="explanation-text" class="fs-5"></p>
        </div>

        <form id="quiz-form">
            <div id="options-container" class="row g-3">
                </div>

            <div class="mt-5 p-4 rounded-4 text-center" style="background: #FFF9E6; border: 2px dashed #D4A017;">
                <p class="small fw-bold text-muted mb-3">HOW CONFIDENT ARE YOU?</p>
                <div class="d-flex justify-content-center gap-2 flex-wrap">
                    <input type="radio" class="btn-check" name="confidence" value="low" id="c1">
                    <label class="btn btn-outline-secondary rounded-pill px-4" for="c1">üò¨ Unsure</label>
                    <input type="radio" class="btn-check" name="confidence" value="medium" id="c2" checked>
                    <label class="btn btn-outline-secondary rounded-pill px-4" for="c2">ü§î Guess</label>
                    <input type="radio" class="btn-check" name="confidence" value="high" id="c3">
                    <label class="btn btn-outline-secondary rounded-pill px-4" for="c3">üòé Expert</label>
                </div>
            </div>

            <div class="mt-5">
                <button type="button" id="action-btn" class="sunshine-btn w-100 py-3 fs-4">Lock In Answer üîí</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Configuration
    let questions = JSON.parse(localStorage.getItem('quiz_questions')) || [];
    let currentIndex = parseInt(localStorage.getItem('current_q_index')) || 0;
    let userAnswers = JSON.parse(localStorage.getItem('user_answers_pool')) || [];
    const quizGoal = localStorage.getItem('quiz_goal') || 'quiz'; // 'quiz' or 'revision'

    let timeLeft = 30;
    let timerInterval;

    function initQuiz() {
        if (currentIndex >= questions.length) {
            calculateAndRedirect();
            return;
        }

        const q = questions[currentIndex];
        
        // Update UI
        document.getElementById('mode-badge').innerText = quizGoal.toUpperCase() + " MODE";
        document.getElementById('mode-badge').className = `badge px-4 py-2 rounded-pill fs-6 shadow-sm ${quizGoal === 'quiz' ? 'bg-danger' : 'bg-warning text-dark'}`;
        document.getElementById('current-q-num').innerText = currentIndex + 1;
        document.getElementById('total-q-num').innerText = questions.length;
        document.getElementById('question-text').innerText = q.question;
        
        const progress = ((currentIndex + 1) / questions.length) * 100;
        document.getElementById('main-progress-bar').style.width = progress + "%";
        document.getElementById('progress-percent').innerText = Math.round(progress) + "%";

        // Render Options
        const container = document.getElementById('options-container');
        container.innerHTML = Object.entries(q.options).map(([key, val]) => `
            <div class="col-md-6">
                <input type="radio" class="btn-check" name="answer" value="${key}" id="opt-${key}" required>
                <label class="btn btn-outline-dark w-100 py-3 text-start rounded-4 fs-5 fw-bold shadow-sm option-card" for="opt-${key}">
                    <span class="text-warning me-2">${key}.</span> ${val}
                </label>
            </div>
        `).join('');

        // Mode specific logic
        if (quizGoal === 'quiz') {
            document.getElementById('ghost-container').classList.remove('d-none');
            document.getElementById('timer-box').classList.remove('d-none');
            startTimer();
        }

        document.getElementById('action-btn').innerText = quizGoal === 'revision' ? "Check Answer" : "Lock In Answer üîí";
    }

    function startTimer() {
        timeLeft = 30;
        document.getElementById('timer').innerText = timeLeft;
        document.getElementById('ghost-bar').style.width = "0%";
        
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            timeLeft--;
            document.getElementById('timer').innerText = timeLeft;
            document.getElementById('ghost-bar').style.width = ((30 - timeLeft) / 30 * 100) + "%";

            if (timeLeft <= 0) {
                handleSubmission(true); // Auto-submit on timeout
            }
        }, 1000);
    }

    async function handleSubmission(isTimeout = false) {
        clearInterval(timerInterval);
        const selected = document.querySelector('input[name="answer"]:checked');
        const ansValue = isTimeout ? null : selected?.value;

        if (!isTimeout && !selected) return alert("Please select an answer!");

        const q = questions[currentIndex];
        const isCorrect = ansValue === q.correct_answer;

        // Save result
        userAnswers.push({
            question: q.question,
            user_ans: ansValue ? q.options[ansValue] : "Time Out",
            correct_ans: q.options[q.correct_answer],
            is_correct: isCorrect,
            explanation: q.explanation
        });

        if (quizGoal === 'revision') {
            showFeedback(isCorrect, q);
        } else {
            nextQuestion();
        }
    }

    function showFeedback(isCorrect, q) {
        const area = document.getElementById('feedback-area');
        area.classList.remove('d-none');
        area.className = `alert ${isCorrect ? 'alert-success' : 'alert-danger'} mb-4 rounded-4 shadow-sm animate__animated animate__bounceIn`;
        document.getElementById('feedback-status').innerText = isCorrect ? "‚ú® Correct!" : "‚ùå Incorrect";
        document.getElementById('explanation-text').innerText = q.explanation;
        
        const btn = document.getElementById('action-btn');
        btn.innerText = "Next Question ‚Üí";
        btn.style.background = "#333";
        btn.onclick = nextQuestion;
    }

    function nextQuestion() {
        currentIndex++;
        localStorage.setItem('current_q_index', currentIndex);
        localStorage.setItem('user_answers_pool', JSON.stringify(userAnswers));
        
        // Reset feedback UI
        document.getElementById('feedback-area').classList.add('d-none');
        document.getElementById('action-btn').onclick = () => handleSubmission(false);
        
        initQuiz();
    }

    function calculateAndRedirect() {
        const correctCount = userAnswers.filter(a => a.is_correct).length;
        const finalData = {
            topic: localStorage.getItem('quiz_topic'),
            score: correctCount,
            total: questions.length,
            user_answers: userAnswers
        };
        localStorage.setItem('lastQuizResult', JSON.stringify(finalData));
        window.location.href = "results.html";
    }

    document.getElementById('action-btn').onclick = () => handleSubmission(false);
    initQuiz();
</script>

</body>
</html>

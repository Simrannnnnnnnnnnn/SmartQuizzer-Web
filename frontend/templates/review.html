<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mistake Bank | SmartQuizzer</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <style>
        :root { --primary-gold: #FFB300; }
        body { background-color: #f8f9fa; font-family: 'Inter', sans-serif; }
        .glass-card { border-radius: 24px; border: 1px solid #eee; transition: 0.3s; }
        .glass-card:hover { 
            transform: translateY(-5px); 
            border-color: var(--primary-gold) !important; 
            box-shadow: 0 10px 30px rgba(255, 179, 0, 0.1) !important;
        }
        .options-grid .option-item { transition: 0.2s; }
        .correct-answer { background: #d1e7dd !important; border-color: #a3cfbb !important; color: #0a3622 !important; font-weight: bold; }
    </style>
</head>
<body>

<div class="container py-5 animate__animated animate__fadeIn">
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <h1 class="fw-bold" style="color: var(--primary-gold);">üìù Mistake Bank</h1>
            <p class="text-muted fs-5">Review your weak spots and turn them into strengths.</p>
        </div>
        <a href="dashboard.html" class="btn btn-outline-dark rounded-pill px-4 shadow-sm fw-bold">
            <i class="fa-solid fa-arrow-left me-2"></i>Dashboard
        </a>
    </div>

    <div id="mistakes-container" class="row g-4">
        <div class="text-center py-5" id="loading-state">
            <div class="spinner-border text-warning" role="status"></div>
            <p class="mt-3 text-muted">Loading your mistakes...</p>
        </div>
    </div>

    <div id="empty-state" class="text-center py-5 d-none">
        <div class="mb-4">
            <i class="fa-solid fa-circle-check text-success display-1 opacity-25"></i>
        </div>
        <h3 class="fw-bold text-muted">No Mistakes Found!</h3>
        <p class="text-muted">You're doing great!</p>
        <a href="study_hub.html" class="btn btn-warning rounded-pill px-5 fw-bold mt-3 text-white">Start Learning</a>
    </div>
</div>

<script>
    // 1. Data Loading Logic
    document.addEventListener('DOMContentLoaded', async function() {
        const container = document.getElementById('mistakes-container');
        const emptyState = document.getElementById('empty-state');
        const loadingState = document.getElementById('loading-state');

        try {
            // LocalStorage se data check karna (Agar user ne abhi quiz khatam kiya ho)
            // Ya fir API call se fetch karna:
            const response = await fetch('https://simrankaurrrrrr-smartquizzer-backend.hf.space/get-mistakes', {
                method: 'GET',
                headers: { 
                    'Authorization': `Bearer ${localStorage.getItem('token')}` // User login token
                }
            });
            
            const data = await response.json();
            const mistakes = data.mistakes || [];

            loadingState.remove();

            if (mistakes.length === 0) {
                emptyState.classList.remove('d-none');
                container.innerHTML = "";
            } else {
                renderMistakes(mistakes);
            }
        } catch (error) {
            console.error("Error fetching mistakes:", error);
            container.innerHTML = `<div class="text-center text-danger">Failed to load mistakes. Please login again.</div>`;
        }
    });

    // 2. Rendering Function
    function renderMistakes(mistakes) {
        const container = document.getElementById('mistakes-container');
        container.innerHTML = mistakes.map((m, index) => `
            <div class="col-lg-6">
                <div class="glass-card p-4 border-2 h-100 position-relative shadow-sm bg-white">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <span class="badge rounded-pill px-3 py-2 bg-warning text-dark fw-bold border">
                            <i class="fa-solid fa-tag me-1"></i> ${m.topic}
                        </span>
                        <small class="text-muted fw-bold">Mistake #${index + 1}</small>
                    </div>

                    <h5 class="fw-bold mb-4 text-dark" style="line-height: 1.5;">${m.question}</h5>

                    <div class="options-grid mb-4">
                        ${Object.entries(m.options).map(([key, val]) => `
                            <div class="p-3 rounded-4 mb-2 border d-flex align-items-center ${key === m.correct_answer ? 'correct-answer' : 'bg-light opacity-75'}">
                                <span class="fw-bold me-3 text-uppercase" style="width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; background: white; border-radius: 50%; border: 1px solid #ddd; font-size: 0.8rem; color: #333;">
                                    ${key}
                                </span>
                                <span>${val}</span>
                                ${key === m.correct_answer ? '<i class="fa-solid fa-check-circle ms-auto text-success"></i>' : ''}
                            </div>
                        `).join('')}
                    </div>

                    <div class="mt-3">
                        <button class="btn btn-sm rounded-pill border-warning text-dark fw-bold bg-warning bg-opacity-10 w-100 py-2" 
                                onclick="toggleExpl('expl-${index}')">
                            <i class="fa-solid fa-lightbulb me-2"></i> Why did I get this wrong?
                        </button>
                        <div id="expl-${index}" class="d-none mt-3 p-3 rounded-4 bg-light border-start border-warning border-4 animate__animated animate__fadeIn">
                            <p class="small mb-0 text-dark" style="line-height: 1.6;">
                                <strong>AI Explanation:</strong> ${m.explanation || "Review the core concepts of " + m.topic + " to strengthen this area."}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // 3. Toggle Explanation UI
    function toggleExpl(id) {
        const div = document.getElementById(id);
        div.classList.toggle('d-none');
    }
</script>

</body>
</html>
